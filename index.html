<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consent Banner Example - View States</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 0; padding-bottom: 150px; }
        header, footer { background-color: #0b2335; color: #ffffff; padding: 1rem 2rem; text-align: center; }
        main { padding: 2rem; min-height: 80vh; }
        footer a { color: #b0c4de; text-decoration: underline; cursor: pointer; }
        footer a:hover { color: #ffffff; }
        #custom-consent-banner, #custom-consent-modal { display: none; z-index: 2147483647; }
        #custom-consent-banner.visible, #custom-consent-modal.visible { display: flex; }
        #custom-consent-banner {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #eaf0f6;
            color: #1c1c1b;
            border-top: 1px solid #d8dde1;
            padding: 30px 30px; /* Increased vertical padding for more height */
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }
        #custom-consent-banner .content { display: flex; align-items: center; justify-content: space-between; max-width: 1200px; width: 100%; gap: 20px; }
        #custom-consent-banner p a { color: #1c1c1b; font-weight: bold; text-decoration: underline; cursor: pointer; }
        #custom-consent-banner .close-btn { font-size: 20px; border: 1px solid #aaa; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; background: transparent; flex-shrink: 0; }
        #custom-consent-banner .confirm-btn {
            background-color: #0d2f53;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 15px 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 1.5em;
            margin-top: 0;
            align-self: auto;
            transition: background 0.2s;
            width: auto;
            min-width: 0;
            display: inline-block;
            box-sizing: border-box;
        }
        #custom-consent-banner .confirm-btn:hover {
            background: #143d6b;
        }
        #custom-consent-modal {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            height: auto;
            top: auto;
            background-color: #eaf0f6;
            color: #1c1c1b;
            border-top: 1px solid #d8dde1;
            box-shadow: 0 -2px 16px rgba(0,0,0,0.08);
            align-items: center;
            justify-content: center;
            z-index: 2147483647;
            display: none;
            padding: 30px 0; /* Add vertical padding for more height above/below confirm button */
        }
        #custom-consent-modal.visible {
            display: flex;
        }
        #custom-consent-modal .modal-content {
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0;
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 0;
        }
        #custom-consent-modal .modal-content h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 1em;
            margin-top: 0;
            color: inherit;
            display: block;
        }
        #custom-consent-modal .modal-row {
            display: flex;
            flex-direction: row;
            gap: 1.5em;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }
        #custom-consent-modal .toggles-row {
            display: contents;
        }
        #custom-consent-modal .toggles-container {
            display: flex;
            gap: 1.5em;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0;
        }
        #custom-consent-modal .confirm-btn {
            background-color: #0d2f53;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 15px 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 1.5em;
            margin-top: 0;
            align-self: auto;
            transition: background 0.2s;
            width: auto;
            min-width: 0;
            display: inline-block;
            box-sizing: border-box;
        }
        #custom-consent-modal .confirm-btn:hover {
            background: #143d6b;
        }
        .view-state-btns { margin: 2rem 0; display: flex; gap: 1rem; justify-content: center; }
        .view-state-btns button { padding: 0.5rem 1.5rem; font-size: 1rem; border-radius: 5px; border: 1px solid #0d2f53; background: #eaf0f6; color: #0d2f53; cursor: pointer; }
        .view-state-btns button.active { background: #0d2f53; color: #fff; }
    </style>
</head>
<body>
    <header><h1>Consent Banner Example - View States</h1></header>
    <main>
        <h2>Demo: Footer Link & Banner View States</h2>
        <div class="view-state-btns">
            <button id="show-banner-btn">Show Banner</button>
            <button id="show-modal-btn">Show Modal</button>
            <button id="hide-all-btn">Hide All</button>
            <button id="reset-btn">Reset Consent</button>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 1em; margin-bottom: 2em;">
            <label><input type="radio" name="region-toggle" value="EU"> Europe (GDPR)</label>
            <label><input type="radio" name="region-toggle" value="CA"> California (CCPA)</label>
            <label><input type="radio" name="region-toggle" value="VA"> Virginia</label>
            <label><input type="radio" name="region-toggle" value="US_OPTIN"> All US Opt-In States</label>
            <label><input type="radio" name="region-toggle" value="US"> USA (General)</label>
            <label><input type="radio" name="region-toggle" value="DEFAULT" checked> Auto (Geo/IP)</label>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 2em;">
            <label style="font-weight:bold;cursor:pointer;">
                <input type="checkbox" id="login-toggle" style="margin-right:8px;"> Simulate Member Login (access to benefits/health info)
            </label>
        </div>
        <p>This page demonstrates a footer link that opens the consent options modal, and buttons to simulate different view states for testing.</p>
    </main>
    <footer><p>© 2023 | <a id="cookie-choices-link">Your Cookie Choices</a></p></footer>

    <div id="custom-consent-banner">
        <div class="content">
            <div>
                <p style="font-size: 1.5em; font-weight: bold; margin-bottom: 1em;">To offer a personalized experience, this site uses cookies & tracking technologies.</p>
                <div style="margin-bottom: 0.5em;">
                    By using our sites, you consent to the recording, use, & sharing of your site activity by us & our providers & agree to our latest 
                    <a href="https://www.vsp.com/legal/privacy-statement" target="_blank" rel="noopener noreferrer">Privacy Statement</a> & 
                    <a href="https://www.vsp.com/legal/terms-and-conditions" target="_blank" rel="noopener noreferrer">Terms and Conditions</a> including the 
                    <a href="https://www.vsp.com/legal/terms-and-conditions?anchor=dispute-resolution" target="_blank" rel="noopener noreferrer">Class Action Waiver</a> & 
                    <a href="https://www.vsp.com/legal/terms-and-conditions?anchor=dispute-resolution" target="_blank" rel="noopener noreferrer">Mandatory Arbitration</a>. 
                    Manage your cookie preferences by clicking on the “Your Cookie Choices” link at the bottom of the page or with the following choices:
                </div>
                <div style="display: flex; flex-direction: row; gap: 1.5em; align-items: center; flex-wrap: wrap;">
                    <div id="banner-toggles-row" style="display: flex; gap: 1.5em; align-items: center; flex-wrap: wrap;"></div>
                    <button id="banner-confirm-btn" class="confirm-btn" style="margin-left: 1.5em; margin-top: 0; align-self: auto;">CONFIRM</button>
                </div>
            </div>
            <button id="close-banner-btn" class="close-btn" aria-label="Close banner">✕</button>
        </div>
    </div>

    <div id="custom-consent-modal">
        <form id="consent-form" class="modal-content">
            <h2 id="consent-modal-title">Please select which types of cookies you would like to have enabled:</h2>
            <div class="modal-row">
                <div class="toggles-container" id="toggles-container">
                    <!-- Toggles will be injected here based on region -->
                </div>
                <button type="submit" class="confirm-btn">CONFIRM</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const banner = document.getElementById('custom-consent-banner');
            const modal = document.getElementById('custom-consent-modal');
            const consentForm = document.getElementById('consent-form');
            const closeBannerBtn = document.getElementById('close-banner-btn');
            const footerLink = document.getElementById('cookie-choices-link');
            const togglesContainer = document.getElementById('toggles-container');
            const modalTitle = document.getElementById('consent-modal-title');
            const bannerTogglesRow = document.getElementById('banner-toggles-row');
            // View state buttons
            const showBannerBtn = document.getElementById('show-banner-btn');
            const showModalBtn = document.getElementById('show-modal-btn');
            const hideAllBtn = document.getElementById('hide-all-btn');
            const resetBtn = document.getElementById('reset-btn');

            // US states requiring opt-in for sensitive data
            const US_OPTIN_STATES = ['VA','CO','CT','UT','OR','TX','MT','TN','IN','DE','IA'];

            // Region-based consent config
            const regionConfigs = {
                'EU': {
                    title: 'Your Privacy Choices (GDPR)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'functional', label: 'Functionality', checked: false },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false, hidden: true } // Not required for GDPR
                    ]
                },
                'CA': {
                    title: 'Your Privacy Choices (California)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false } // CCPA/CPRA requires this
                    ]
                },
                'VA': {
                    title: 'Your Privacy Choices (Virginia)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'US_OPTIN': {
                    title: 'Your Privacy Choices (All US Opt-In States)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'CO': {
                    title: 'Your Privacy Choices (Colorado)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'CT': {
                    title: 'Your Privacy Choices (Connecticut)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'UT': {
                    title: 'Your Privacy Choices (Utah)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'OR': {
                    title: 'Your Privacy Choices (Oregon)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'TX': {
                    title: 'Your Privacy Choices (Texas)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'MT': {
                    title: 'Your Privacy Choices (Montana)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'TN': {
                    title: 'Your Privacy Choices (Tennessee)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'IN': {
                    title: 'Your Privacy Choices (Indiana)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'DE': {
                    title: 'Your Privacy Choices (Delaware)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'IA': {
                    title: 'Your Privacy Choices (Iowa)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                },
                'US': {
                    title: 'Your Cookie Choices (USA)',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false } // For general US, show for completeness
                    ]
                },
                'DEFAULT': {
                    title: 'Your Cookie Choices',
                    toggles: [
                        { name: 'essential', label: 'Essential purposes', checked: true, disabled: true },
                        { name: 'analytics', label: 'Analytics', checked: false },
                        { name: 'advertising', label: 'Advertising', checked: false },
                        { name: 'sale', label: 'Sale of personal information', checked: false }
                    ]
                }
            };

            function getRegionConfig(region) {
                if (region === 'EU') return regionConfigs['EU'];
                if (region === 'CA') return regionConfigs['CA'];
                if (region === 'VA') return regionConfigs['VA'];
                if (region === 'US_OPTIN') return regionConfigs['US_OPTIN'];
                if (region === 'US') return regionConfigs['US'];
                return regionConfigs['DEFAULT'];
            }

            // Simulate whether the user is logged in (for demo)
            let isLoggedIn = false;

            function renderToggles(region) {
                const config = getRegionConfig(region);
                modalTitle.textContent = config.title;
                togglesContainer.innerHTML = '';
                bannerTogglesRow.innerHTML = '';
                config.toggles.forEach(t => {
                    if (t.hidden) return; // Hide toggles not required for region
                    // Modal toggles
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = t.name;
                    // Opt-in for all non-essential cookies in opt-in states and when logged in
                    if ((region === 'US_OPTIN' || isLoggedIn) && !t.disabled) {
                        input.checked = false;
                    } else if (region === 'CA' && !isLoggedIn && !t.disabled) {
                        input.checked = true;
                    } else {
                        input.checked = t.checked;
                    }
                    if (t.disabled) input.disabled = true;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(' ' + t.label));
                    togglesContainer.appendChild(label);
                    // Banner toggles (clone for banner row)
                    const bannerLabel = document.createElement('label');
                    const bannerInput = document.createElement('input');
                    bannerInput.type = 'checkbox';
                    bannerInput.name = t.name;
                    if ((region === 'US_OPTIN' || isLoggedIn) && !t.disabled) {
                        bannerInput.checked = false;
                    } else if (region === 'CA' && !isLoggedIn && !t.disabled) {
                        bannerInput.checked = true;
                    } else {
                        bannerInput.checked = t.checked;
                    }
                    if (t.disabled) bannerInput.disabled = true;
                    bannerLabel.appendChild(bannerInput);
                    bannerLabel.appendChild(document.createTextNode(' ' + t.label));
                    bannerTogglesRow.appendChild(bannerLabel);
                });
            }

            // Region radio toggle
            const regionRadios = document.querySelectorAll('input[name="region-toggle"]');
            let forcedRegion = null;

            regionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    forcedRegion = radio.value;
                    if (forcedRegion === 'DEFAULT') {
                        // Re-run geo lookup
                        fetch('https://ipapi.co/json/')
                            .then(res => res.json())
                            .then(data => {
                                let region = 'DEFAULT';
                                if (data && data.country_code === 'US') {
                                    const optInStates = ['VA','CO','CT','UT','OR','TX','MT','TN','IN','DE','IA'];
                                    if (optInStates.includes(data.region_code)) region = 'US_OPTIN';
                                    else if (data.region_code === 'CA') region = 'CA';
                                    else region = 'US';
                                } else if (data && [
                                    'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','IS','LI','NO','CH'
                                ].includes(data.country_code)) {
                                    region = 'EU';
                                }
                                renderToggles(region);
                            })
                            .catch(() => renderToggles('DEFAULT'));
                    } else {
                        renderToggles(forcedRegion);
                    }
                });
            });

            // Fetch region and render toggles
            function geoRenderToggles() {
                fetch('https://ipapi.co/json/')
                    .then(res => res.json())
                    .then(data => {
                        let region = 'DEFAULT';
                        if (data && data.country_code === 'US') {
                            const optInStates = ['VA','CO','CT','UT','OR','TX','MT','TN','IN','DE','IA'];
                            if (optInStates.includes(data.region_code)) region = 'US_OPTIN';
                            else if (data.region_code === 'CA') region = 'CA';
                            else region = 'US';
                        } else if (data && [
                            'AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','IS','LI','NO','CH'
                        ].includes(data.country_code)) {
                            region = 'EU';
                        }
                        renderToggles(region);
                    })
                    .catch(() => renderToggles('DEFAULT'));
            }

            // On load, use geo or forced region
            if (!localStorage.getItem('vsp_consent_status')) {
                const checkedRadio = document.querySelector('input[name="region-toggle"]:checked');
                if (checkedRadio && checkedRadio.value !== 'DEFAULT') {
                    renderToggles(checkedRadio.value);
                } else {
                    geoRenderToggles();
                }
            }

            // Always allow showing the banner for changing choices
            showBannerBtn.addEventListener('click', () => {
                banner.classList.add('visible');
                modal.classList.remove('visible');
            });

            const hideAll = () => { banner.classList.remove('visible'); modal.classList.remove('visible'); };
            closeBannerBtn.addEventListener('click', () => { hideAll(); localStorage.setItem('vsp_consent_status', 'dismissed'); });
            footerLink.addEventListener('click', (e) => { e.preventDefault(); modal.classList.add('visible'); });

            // View state buttons
            showBannerBtn.addEventListener('click', () => { banner.classList.add('visible'); modal.classList.remove('visible'); });
            showModalBtn.addEventListener('click', () => { modal.classList.add('visible'); banner.classList.remove('visible'); });
            hideAllBtn.addEventListener('click', () => { hideAll(); });
            resetBtn.addEventListener('click', () => { localStorage.removeItem('vsp_consent_status'); banner.classList.add('visible'); modal.classList.remove('visible'); });

            consentForm.addEventListener('submit', async (clickEvent) => {
                clickEvent.preventDefault(); 
                hideAll();
                const toggles = consentForm.querySelectorAll('input[type="checkbox"]');
                const consentChoices = {};
                toggles.forEach(toggle => { consentChoices[toggle.name] = toggle.checked; });
                const authEvent = window.airgapAuthEvent || clickEvent;
                try {
                    const transcend = await new Promise(resolve => self.transcend.ready(resolve));
                    await transcend.setConsent(authEvent, consentChoices);
                    await transcend.sync();
                    console.log('SUCCESS: Consent set locally and sync call initiated.');
                    localStorage.setItem('vsp_consent_status', 'configured');
                } catch (error) {
                    console.error('An error occurred during consent processing:', error);
                }
            });

            // Add a toggle to simulate login state for demo purposes
            const loginToggle = document.getElementById('login-toggle');
            loginToggle.addEventListener('change', () => {
                isLoggedIn = loginToggle.checked;
                // Re-render toggles for current region
                const checkedRadio = document.querySelector('input[name="region-toggle"]:checked');
                if (checkedRadio && checkedRadio.value !== 'DEFAULT') {
                    renderToggles(checkedRadio.value);
                } else {
                    geoRenderToggles();
                }
            });

            const bannerConfirmBtn = document.getElementById('banner-confirm-btn');
            bannerConfirmBtn.addEventListener('click', async (clickEvent) => {
                // Collect choices from banner toggles
                const toggles = bannerTogglesRow.querySelectorAll('input[type="checkbox"]');
                const consentChoices = {};
                toggles.forEach(toggle => { consentChoices[toggle.name] = toggle.checked; });
                const authEvent = window.airgapAuthEvent || clickEvent;
                try {
                    const transcend = await new Promise(resolve => self.transcend.ready(resolve));
                    await transcend.setConsent(authEvent, consentChoices);
                    await transcend.sync();
                    console.log('SUCCESS: Consent set locally and sync call initiated.');
                    localStorage.setItem('vsp_consent_status', 'configured');
                } catch (error) {
                    console.error('An error occurred during consent processing:', error);
                }
                // Always hide the banner after clicking confirm
                banner.classList.remove('visible');
            });
        });
    </script>
</body>
</html>
